USE TimesheetDB;
GO

-- ???????????????????????????????????????????????????????????????
-- 1. Employee dimension
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.Employee','U') IS NOT NULL
    DROP TABLE dbo.Employee;
GO

CREATE TABLE dbo.Employee (
    EmployeeID   INT IDENTITY(1,1) PRIMARY KEY,
    EmployeeName VARCHAR(150)      NOT NULL,

    CONSTRAINT UQ_Employee_EmployeeName
      UNIQUE (EmployeeName)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 2. Client dimension
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.Client','U') IS NOT NULL
    DROP TABLE dbo.Client;
GO

CREATE TABLE dbo.Client (
    ClientID   INT IDENTITY(1,1) PRIMARY KEY,
    ClientName VARCHAR(200)      NOT NULL,

    CONSTRAINT UQ_Client_ClientName
      UNIQUE (ClientName)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 3. Project dimension
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.Project','U') IS NOT NULL
    DROP TABLE dbo.Project;
GO

CREATE TABLE dbo.Project (
    ProjectID   INT IDENTITY(1,1) PRIMARY KEY,
    ClientID    INT                NOT NULL
      CONSTRAINT FK_Project_Client
        REFERENCES dbo.Client(ClientID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    ProjectName VARCHAR(200)       NOT NULL,

    CONSTRAINT UQ_Project_ClientID_ProjectName
      UNIQUE (ClientID, ProjectName)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 4. ExpenseCategory lookup
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.ExpenseCategory','U') IS NOT NULL
    DROP TABLE dbo.ExpenseCategory;
GO

CREATE TABLE dbo.ExpenseCategory (
    ExpenseCategoryID INT IDENTITY(1,1) PRIMARY KEY,
    CategoryName      VARCHAR(100)       NOT NULL,

    CONSTRAINT UQ_ExpenseCategory_CategoryName
      UNIQUE (CategoryName)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 5. LeaveType lookup
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.LeaveType','U') IS NOT NULL
    DROP TABLE dbo.LeaveType;
GO

CREATE TABLE dbo.LeaveType (
    LeaveTypeID   INT IDENTITY(1,1) PRIMARY KEY,
    TypeName      VARCHAR(100)      NOT NULL,

    CONSTRAINT UQ_LeaveType_TypeName
      UNIQUE (TypeName)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 6. TimesheetEntry (Fact table)
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.TimesheetEntry','U') IS NOT NULL
    DROP TABLE dbo.TimesheetEntry;
GO

CREATE TABLE dbo.TimesheetEntry (
    TimesheetID    BIGINT IDENTITY(1,1) PRIMARY KEY,
    
    EmployeeID     INT                 NOT NULL
      CONSTRAINT FK_TimesheetEntry_Employee
        REFERENCES dbo.Employee(EmployeeID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    ProjectID      INT                 NOT NULL
      CONSTRAINT FK_TimesheetEntry_Project
        REFERENCES dbo.Project(ProjectID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    WorkDate       DATE                NOT NULL,
    Billable       BIT                 NOT NULL  DEFAULT (0),
    Description    VARCHAR(500)        NULL,
    Comments       VARCHAR(MAX)        NULL,
    HoursDecimal   DECIMAL(5,2)        NOT NULL,
    StartTime      TIME(0)             NULL,
    EndTime        TIME(0)             NULL,

    CONSTRAINT UQ_Timesheet_Employee_Project_Date
      UNIQUE (EmployeeID, ProjectID, WorkDate)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 7. ExpenseEntry (Fact table)
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.ExpenseEntry','U') IS NOT NULL
    DROP TABLE dbo.ExpenseEntry;
GO

CREATE TABLE dbo.ExpenseEntry (
    ExpenseID         BIGINT IDENTITY(1,1) PRIMARY KEY,
    
    EmployeeID        INT                 NOT NULL
      CONSTRAINT FK_Expense_Employee
        REFERENCES dbo.Employee(EmployeeID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    ExpenseDate       DATE                NOT NULL,
    
    ExpenseCategoryID INT                 NOT NULL
      CONSTRAINT FK_Expense_ExpenseCategory
        REFERENCES dbo.ExpenseCategory(ExpenseCategoryID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    ExpenseDesc       VARCHAR(500)        NULL,
    AmountDEC         DECIMAL(12,2)       NOT NULL,

    CONSTRAINT UQ_Expense_Employee_Date_Category
      UNIQUE (EmployeeID, ExpenseDate, ExpenseCategoryID)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 8. LeaveEntry (Fact table)
-- ???????????????????????????????????????????????????????????????
IF OBJECT_ID('dbo.LeaveEntry','U') IS NOT NULL
    DROP TABLE dbo.LeaveEntry;
GO

CREATE TABLE dbo.LeaveEntry (
    LeaveID           BIGINT IDENTITY(1,1) PRIMARY KEY,
    
    EmployeeID        INT                 NOT NULL
      CONSTRAINT FK_Leave_Employee
        REFERENCES dbo.Employee(EmployeeID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    LeaveTypeID       INT                 NOT NULL
      CONSTRAINT FK_Leave_LeaveType
        REFERENCES dbo.LeaveType(LeaveTypeID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    
    StartDate         DATE                NOT NULL,
    EndDate           DATE                NOT NULL,
    NumberOfDays      DECIMAL(5,2)        NOT NULL,
    ApprovalObtained  BIT                 NOT NULL  DEFAULT (0),
    SickNoteFilePath  VARCHAR(260)        NULL,
    AddressDuringLeave VARCHAR(500)       NULL,

    CONSTRAINT UQ_Leave_Employee_Start_End
      UNIQUE (EmployeeID, StartDate, EndDate)
);
GO


-- ???????????????????????????????????????????????????????????????
-- 9. (Optional) Indexes for better query performance
-- ???????????????????????????????????????????????????????????????
CREATE NONCLUSTERED INDEX IX_TS_Employee_WorkDate
  ON dbo.TimesheetEntry (EmployeeID, WorkDate);

CREATE NONCLUSTERED INDEX IX_TS_Project_WorkDate
  ON dbo.TimesheetEntry (ProjectID, WorkDate);

CREATE NONCLUSTERED INDEX IX_EXP_Employee_ExpenseDate
  ON dbo.ExpenseEntry (EmployeeID, ExpenseDate);

CREATE NONCLUSTERED INDEX IX_LEAVE_Employee_StartDate
  ON dbo.LeaveEntry (EmployeeID, StartDate);

CREATE NONCLUSTERED INDEX IX_ExpenseCategory_CategoryName
  ON dbo.ExpenseCategory (CategoryName);

CREATE NONCLUSTERED INDEX IX_LeaveType_TypeName
  ON dbo.LeaveType (TypeName);
GO
